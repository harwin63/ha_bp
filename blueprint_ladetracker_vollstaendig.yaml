blueprint:
  name: "âš¡ Energie-Ladetracker (vollstÃ¤ndig)"
  description: >
    Misst Verbrauch und Kosten eines Ladevorgangs vollstÃ¤ndig und persistent.
    Zeigt Echtzeit-Werte wÃ¤hrend des Ladens, speichert Ergebnis nach Ladeende
    und setzt sich automatisch fÃ¼r den nÃ¤chsten Ladevorgang zurÃ¼ck.

    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    EINMALIGE VORBEREITUNG (pro GerÃ¤t, 3 Helfer anlegen):
    Einstellungen â†’ GerÃ¤te & Dienste â†’ Helfer â†’ Helfer erstellen â†’ Zahl
    
    Helfer 1 â€“ Interner Startwert:
      Name:     z.B. "Fahrradakku Ladestart intern"
      Min: 0 / Max: 999999 / Schritt: 0.001 / Einheit: kWh
    
    Helfer 2 â€“ Letzter Verbrauch:
      Name:     z.B. "Fahrradakku Verbrauch kWh"
      Min: 0 / Max: 999 / Schritt: 0.001 / Einheit: kWh
    
    Helfer 3 â€“ Letzte Kosten:
      Name:     z.B. "Fahrradakku Kosten EUR"
      Min: 0 / Max: 999 / Schritt: 0.001 / Einheit: â‚¬
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  domain: automation
  source_url: https://github.com/home-assistant/core

  input:

    # â”€â”€ GerÃ¤t â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    device_name:
      name: "ðŸ“› GerÃ¤tename"
      description: "Frei wÃ¤hlbarer Name, erscheint in Benachrichtigungen. Z.B. 'Fahrradakku', 'E-Scooter', 'Laptop'."
      default: "Akku"
      selector:
        text:

    # â”€â”€ Sensoren â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    power_sensor:
      name: "âš¡ Leistungssensor (Watt)"
      description: "Sensor des Smartplugs mit aktueller Leistung in Watt."
      selector:
        entity:
          domain: sensor
          device_class: power

    energy_sensor:
      name: "ðŸ”‹ EnergiezÃ¤hler (kWh)"
      description: "Sensor des Smartplugs mit kumuliertem Energieverbrauch in kWh. Dieser Wert darf nie zurÃ¼ckspringen!"
      selector:
        entity:
          domain: sensor
          device_class: energy

    # â”€â”€ Input-Number Helfer (vorab anlegen!) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    helper_start:
      name: "ðŸ”§ Helfer: Startwert (intern)"
      description: >
        input_number Helfer fÃ¼r den internen ZÃ¤hlerstand bei Ladestart.
        Einheit: kWh / Min: 0 / Max: 999999 / Schritt: 0.001
      selector:
        entity:
          domain: input_number

    helper_verbrauch:
      name: "ðŸ”§ Helfer: Verbrauch kWh (Ergebnis)"
      description: >
        input_number Helfer fÃ¼r den gespeicherten Verbrauch des letzten Ladevorgangs.
        Einheit: kWh / Min: 0 / Max: 999 / Schritt: 0.001
      selector:
        entity:
          domain: input_number

    helper_kosten:
      name: "ðŸ”§ Helfer: Kosten EUR (Ergebnis)"
      description: >
        input_number Helfer fÃ¼r die gespeicherten Kosten des letzten Ladevorgangs.
        Einheit: â‚¬ / Min: 0 / Max: 999 / Schritt: 0.001
      selector:
        entity:
          domain: input_number

    # â”€â”€ Schwellwerte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    power_on_threshold:
      name: "â–¶ï¸ Einschaltschwelle (Watt)"
      description: "Ab dieser Leistung gilt Laden als gestartet. Standbystrom deines GerÃ¤ts beachten!"
      default: 2
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "W"
          mode: slider

    power_off_threshold:
      name: "â¹ï¸ Ausschaltschwelle (Watt)"
      description: "Unter dieser Leistung gilt Laden als beendet. Etwas Ã¼ber dem Standbystrom einstellen."
      default: 5
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "W"
          mode: slider

    power_off_duration:
      name: "â±ï¸ Wartezeit bei Ladeende (Minuten)"
      description: "Wie lange muss die Leistung unter der Schwelle bleiben? Verhindert FehlauslÃ¶sungen bei kurzen Unterbrechungen."
      default: 2
      selector:
        number:
          min: 1
          max: 60
          unit_of_measurement: "min"
          mode: slider

    power_on_delay:
      name: "â±ï¸ Wartezeit bei Ladestart (Sekunden)"
      description: "Kurze VerzÃ¶gerung nach Einschalten, um Einschaltspitzen zu ignorieren."
      default: 10
      selector:
        number:
          min: 5
          max: 60
          unit_of_measurement: "s"
          mode: slider

    # â”€â”€ Kosten â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    electricity_price_helper:
      name: "ðŸ’° Strompreis-Helfer (input_number)"
      description: >
        Dein vorhandener input_number Helfer mit dem aktuellen Strompreis in â‚¬/kWh.
        So gilt eine PreisÃ¤nderung automatisch fÃ¼r alle Blueprint-Instanzen!
      selector:
        entity:
          domain: input_number

    # â”€â”€ Benachrichtigungen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    notify_on_start:
      name: "ðŸ”” Benachrichtigung bei Ladestart"
      description: "Soll beim Erkennen des Ladevorgangs eine Meldung erscheinen?"
      default: true
      selector:
        boolean:

    notify_service:
      name: "ðŸ“± Benachrichtigungsdienst"
      description: >
        Welcher Dienst soll die Abschluss-Benachrichtigung senden?
        notify.persistent_notification = HA-OberflÃ¤che
        notify.mobile_app_DEIN_HANDY   = Push aufs Smartphone
      default: "notify.persistent_notification"
      selector:
        text:


# â”€â”€ Variablen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
variables:
  power_sensor: !input power_sensor
  energy_sensor: !input energy_sensor
  helper_start: !input helper_start
  helper_verbrauch: !input helper_verbrauch
  helper_kosten: !input helper_kosten
  device_name: !input device_name
  electricity_price_helper: !input electricity_price_helper
  electricity_price: "{{ states(electricity_price_helper) | float(0.32) }}"
  notify_on_start: !input notify_on_start
  notify_service: !input notify_service


# â”€â”€ Trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
trigger:
  - platform: numeric_state
    id: "laden_gestartet"
    entity_id: !input power_sensor
    above: !input power_on_threshold
    for:
      seconds: !input power_on_delay

  - platform: numeric_state
    id: "laden_beendet"
    entity_id: !input power_sensor
    below: !input power_off_threshold
    for:
      minutes: !input power_off_duration


# â”€â”€ Aktionen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
action:
  - choose:

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LADEVORGANG GESTARTET
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: trigger
            id: "laden_gestartet"
          # Nur auslÃ¶sen wenn noch kein Ladevorgang lÃ¤uft
          - condition: template
            value_template: >
              {{ states(helper_start) | float(0) == 0 }}

        sequence:
          # Aktuellen ZÃ¤hlerstand als Referenz speichern
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_start }}"
            data:
              value: "{{ states(energy_sensor) | float(0) }}"

          # Optional: Benachrichtigung bei Start
          - if:
              - condition: template
                value_template: "{{ notify_on_start }}"
            then:
              - service: "{{ notify_service }}"
                data:
                  title: "ðŸ”Œ {{ device_name }} â€“ Laden gestartet"
                  message: >
                    Ladevorgang erkannt.
                    ZÃ¤hlerstand: {{ states(energy_sensor) | float(0) | round(3) }} kWh


      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LADEVORGANG BEENDET
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - conditions:
          - condition: trigger
            id: "laden_beendet"
          # Nur wenn tatsÃ¤chlich ein Ladevorgang lief
          - condition: template
            value_template: >
              {{ states(helper_start) | float(0) > 0 }}

        sequence:
          # â”€â”€ Verbrauch berechnen & speichern â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_verbrauch }}"
            data:
              value: >
                {% set aktuell = states(energy_sensor) | float(0) %}
                {% set start   = states(helper_start) | float(0) %}
                {{ [aktuell - start, 0] | max | round(3) }}

          # â”€â”€ Kosten berechnen & speichern â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - service: input_number.set_value
            target:
              entity_id: "{{ helper_kosten }}"
            data:
              value: >
                {% set aktuell = states(energy_sensor) | float(0) %}
                {% set start   = states(helper_start) | float(0) %}
                {% set kwh     = [aktuell - start, 0] | max %}
                {{ (kwh * electricity_price) | round(3) }}

          # â”€â”€ Ergebnis-Benachrichtigung â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - service: "{{ notify_service }}"
            data:
              title: "âœ… {{ device_name }} â€“ Ladevorgang abgeschlossen"
              message: >
                {% set aktuell = states(energy_sensor) | float(0) %}
                {% set start   = states(helper_start) | float(0) %}
                {% set kwh     = [aktuell - start, 0] | max | round(3) %}
                {% set kosten  = (kwh * electricity_price) | round(2) %}
                ðŸ”‹ Verbrauch:  {{ kwh }} kWh
                ðŸ’° Kosten:     {{ kosten }} â‚¬
                ðŸ“Š Strompreis: {{ electricity_price }} â‚¬/kWh

          # â”€â”€ Kurz warten, dann Startwert zurÃ¼cksetzen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          - delay:
              seconds: 3

          - service: input_number.set_value
            target:
              entity_id: "{{ helper_start }}"
            data:
              value: 0


# â”€â”€ Modus: single verhindert parallele LÃ¤ufe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mode: single
max_exceeded: silent
