# ===========================================================================
# BLUEPRINT: Schlafzimmer Beleuchtung mit Nachtmodus (flexibel)
# ===========================================================================
# Voraussetzung: Die Helfer aus "helfer.yaml" müssen vorher erstellt werden.
# ===========================================================================

blueprint:
  name: Schlafzimmer Beleuchtung mit Nachtmodus (flexibel)
  description: >
    Steuerung der Schlafzimmer-Beleuchtung über einen Bewegungsmelder.
    Tagsüber leuchtet das Licht hell, morgens und abends gedimmt.
    Ein manueller Nachtmodus verhindert, dass das Licht nachts angeht.
    Die Zeitgrenzen können entweder als feste Uhrzeiten oder über
    Sonnenauf-/Untergang mit freiem Offset konfiguriert werden –
    beides über Helfer im HA-Dashboard änderbar ohne YAML-Anpassung.
  domain: automation
  input:
    bewegungsmelder:
      name: Bewegungsmelder
      description: Der Bewegungsmelder im Schlafzimmer.
      selector:
        entity:
          domain: binary_sensor
          device_class:
            - motion
            - occupancy

    licht:
      name: Licht (dimmbar)
      description: Das dimmbare Licht im Schlafzimmer.
      selector:
        entity:
          domain: light

    nachtmodus_toggle:
      name: Nachtmodus-Toggle
      description: Der input_boolean für den Nachtmodus (aus helfer.yaml).
      selector:
        entity:
          domain: input_boolean

    zeitsteuerung_modus:
      name: Zeitsteuerung Modus
      description: >
        Der input_select für den Modus: "Uhrzeit" oder "Sonnen-Event"
        (aus helfer.yaml).
      selector:
        entity:
          domain: input_select

    morgen_ende_uhrzeit:
      name: Morgen Ende (Uhrzeit-Helfer)
      description: Der input_datetime für die Morgen-Ende-Uhrzeit.
      selector:
        entity:
          domain: input_datetime

    morgen_ende_offset:
      name: Morgen Ende (Offset-Helfer)
      description: Der input_number für den Offset in Minuten (Morgen Ende).
      selector:
        entity:
          domain: input_number

    abend_start_uhrzeit:
      name: Abend Start (Uhrzeit-Helfer)
      description: Der input_datetime für die Abend-Start-Uhrzeit.
      selector:
        entity:
          domain: input_datetime

    abend_start_offset:
      name: Abend Start (Offset-Helfer)
      description: Der input_number für den Offset in Minuten (Abend Start).
      selector:
        entity:
          domain: input_number

    helligkeit_tag:
      name: Helligkeit Tagsüber
      description: Helligkeit in Prozent (tagsüber).
      default: 100
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    helligkeit_abend_morgen:
      name: Helligkeit Abend / Morgen
      description: Helligkeit in Prozent (morgens und abends).
      default: 15
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"

    ausschalt_wartezeit:
      name: Ausschalt-Wartezeit nach letzter Bewegung
      description: >
        Wie lange das Licht nach der letzten Bewegung noch bleibt (in Sekunden).
      default: 120
      selector:
        number:
          min: 10
          max: 1800
          unit_of_measurement: "s"

# ---------------------------------------------------------------------------
# TRIGGER: Bewegung erkannt
# ---------------------------------------------------------------------------
trigger:
  - platform: state
    entity_id: !input bewegungsmelder
    to: "on"

# ---------------------------------------------------------------------------
# BEDINGUNG: Nachtmodus muss NICHT aktiv sein
# ---------------------------------------------------------------------------
condition:
  - condition: state
    entity_id: !input nachtmodus_toggle
    state: "off"

# ---------------------------------------------------------------------------
# AKTION: Helligkeit anhand der Zeitphase bestimmen
# ---------------------------------------------------------------------------
# Wie funktioniert die Zeitlogik?
#   - Wenn Modus = "Uhrzeit": Direkt die Uhrzeiten aus den input_datetime-Helpern verwenden.
#   - Wenn Modus = "Sonnen-Event": Das Sonnen-Event (states.sun) + Offset berechnen.
#   - Das Template gibt jeweils True/False zurück, ob wir in der Morgen- bzw. Abend-Phase sind.
# ---------------------------------------------------------------------------
action:
  - choose:
      # MORGEN-PHASE: vor der Morgen-Ende-Zeit
      - conditions:
          - condition: template
            value_template: >
              {%- set modus = states('input_select.schlafzimmer_zeitsteuerung_modus') -%}
              {%- if modus == 'Uhrzeit' -%}
                {%- set morgen_ende = states('input_datetime.schlafzimmer_morgen_ende_uhrzeit') -%}
                {{ now().strftime('%H:%M') < morgen_ende }}
              {%- else -%}
                {%- set offset_min = states('input_number.schlafzimmer_morgen_ende_offset') | float(0) -%}
                {%- set sonnenaufgang = states.sun.rising | as_timestamp -%}
                {%- set morgen_ende = (sonnenaufgang + (offset_min * 60)) | as_datetime -%}
                {{ now() < morgen_ende }}
              {%- endif -%}
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input licht
            data:
              brightness_pct: !input helligkeit_abend_morgen
              transition: 2

      # ABEND-PHASE: ab der Abend-Start-Zeit
      - conditions:
          - condition: template
            value_template: >
              {%- set modus = states('input_select.schlafzimmer_zeitsteuerung_modus') -%}
              {%- if modus == 'Uhrzeit' -%}
                {%- set abend_start = states('input_datetime.schlafzimmer_abend_start_uhrzeit') -%}
                {{ now().strftime('%H:%M') >= abend_start }}
              {%- else -%}
                {%- set offset_min = states('input_number.schlafzimmer_abend_start_offset') | float(0) -%}
                {%- set sonnenuntergang = states.sun.setting | as_timestamp -%}
                {%- set abend_start = (sonnenuntergang + (offset_min * 60)) | as_datetime -%}
                {{ now() >= abend_start }}
              {%- endif -%}
        sequence:
          - service: light.turn_on
            target:
              entity_id: !input licht
            data:
              brightness_pct: !input helligkeit_abend_morgen
              transition: 2

    # STANDARD (Tagsüber): zwischen Morgen-Ende und Abend-Start
    default:
      - service: light.turn_on
        target:
          entity_id: !input licht
        data:
          brightness_pct: !input helligkeit_tag
          transition: 1

  # ---------------------------------------------------------------------------
  # Licht nach Inaktivität wieder ausschalten
  # ---------------------------------------------------------------------------
  - wait_for_trigger:
      - platform: state
        entity_id: !input bewegungsmelder
        to: "on"
    timeout:
      seconds: !input ausschalt_wartezeit
  - condition: state
    entity_id: !input bewegungsmelder
    state: "off"
  - service: light.turn_off
    target:
      entity_id: !input licht
    data:
      transition: 2
