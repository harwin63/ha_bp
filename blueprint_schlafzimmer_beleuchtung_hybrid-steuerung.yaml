blueprint:
  name: Schlafzimmer Beleuchtung (Hybrid-Steuerung)
  description: "Steuert Licht über Bewegung mit Adaptive Lighting. Erlaubt sowohl feste Werte als auch Helfer-Entitäten. Ist ein helfer eingetragen, hat dieser Vorrang."
  domain: automation
  input:
    bewegungsmelder:
      name: Bewegungsmelder
      selector:
        entity:
          domain: binary_sensor
          device_class: motion
    licht:
      name: Licht
      selector:
        entity:
          domain: light
    adaptive_sleep_switch:
      name: Adaptive Lighting Sleep Mode Schalter
      description: "Entität 'switch.adaptive_lighting_sleep_mode_...'"
      selector:
        entity:
          domain: switch
    nachtmodus_toggle:
      name: Nachtmodus-Schalter
      description: "Wenn AN, bleibt das Licht aus."
      selector:
        entity:
          domain: [switch, input_boolean]
    
    # --- MORGEN EINSTELLUNGEN ---
    morgen_ende_uhrzeit_fest:
      name: Morgen Ende (Festwert)
      default: "09:00:00"
      selector:
        time: {}
    morgen_ende_uhrzeit_helfer:
      name: Morgen Ende (Helfer-Option)
      default: []
      selector:
        entity:
          domain: input_datetime

    # --- ABEND EINSTELLUNGEN ---
    abend_start_uhrzeit_fest:
      name: Abend Start (Festwert)
      default: "20:00:00"
      selector:
        time: {}
    abend_start_uhrzeit_helfer:
      name: Abend Start (Helfer-Option)
      default: []
      selector:
        entity:
          domain: input_datetime

    # --- WARTEZEIT ---
    ausschalt_wartezeit_fest:
      name: Wartezeit (Festwert Sek.)
      default: 120
      selector:
        number:
          min: 5
          max: 1800
          unit_of_measurement: s
    ausschalt_wartezeit_helfer:
      name: Wartezeit (Helfer-Option)
      default: []
      selector:
        entity:
          domain: input_number

variables:
  # Import der Inputs für Templates
  m_ende_f: !input morgen_ende_uhrzeit_fest
  m_ende_h: !input morgen_ende_uhrzeit_helfer
  a_start_f: !input abend_start_uhrzeit_fest
  a_start_h: !input abend_start_uhrzeit_helfer
  w_fest: !input ausschalt_wartezeit_fest
  w_helfer: !input ausschalt_wartezeit_helfer

  # Entscheidungs-Logik: Helfer vor Festwert
  morgen_ende: "{{ states(m_ende_h) if m_ende_h != [] else m_ende_f }}"
  abend_start: "{{ states(a_start_h) if a_start_h != [] else a_start_f }}"
  wartezeit: "{{ states(w_helfer) | int if w_helfer != [] else w_fest | int }}"

trigger:
  - platform: state
    entity_id: !input bewegungsmelder
    to: "on"

condition:
  - condition: state
    entity_id: !input nachtmodus_toggle
    state: "off"

action:
  - choose:
      # PRÜFUNG: Soll gedimmt werden? (Morgen oder Abend)
      - conditions:
          - condition: or
            conditions:
              - condition: template # Morgen
                value_template: "{{ now().strftime('%H:%M:%S') < morgen_ende }}"
              - condition: template # Abend
                value_template: "{{ now().strftime('%H:%M:%S') >= abend_start }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input adaptive_sleep_switch
          - service: light.turn_on
            target:
              entity_id: !input licht
            data:
              transition: 2

    # DEFAULT: TAGSÜBER
    default:
      - service: switch.turn_off
        target:
          entity_id: !input adaptive_sleep_switch
      - service: light.turn_on
        target:
          entity_id: !input licht
        data:
          transition: 1

  # Ausschalt-Logik
  - wait_for_trigger:
      - platform: state
        entity_id: !input bewegungsmelder
        to: "off"
        for:
          seconds: "{{ wartezeit }}"
  
  - service: light.turn_off
    target:
      entity_id: !input licht
    data:
      transition: 3
